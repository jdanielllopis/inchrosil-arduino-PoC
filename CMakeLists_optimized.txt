 cmake_minimum_required(VERSION 3.16)
project(DNASerialProcessorOptimized VERSION 2.0 LANGUAGES CXX)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Platform detection
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64")
    set(IS_ARM64 TRUE)
    message(STATUS "Detected ARM64 architecture (aarch64)")
else()
    set(IS_ARM64 FALSE)
    message(WARNING "Not on ARM64 - hardware acceleration may be limited")
endif()

# Optimization flags for Raspberry Pi 5 (Cortex-A76)
if(IS_ARM64)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv8.2-a -mtune=cortex-a76")
    message(STATUS "Enabling Cortex-A76 optimizations")
endif()

# Release build optimizations
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")

# Add compiler warnings
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic")

# Find required packages
find_package(Threads REQUIRED)
find_package(OpenSSL REQUIRED)
find_package(SQLite3 REQUIRED)

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${OPENSSL_INCLUDE_DIR}
    ${SQLite3_INCLUDE_DIRS}
)

# Source files (implementation would be in separate .cpp files)
set(SOURCES
    dna_serial_example_optimized.cpp
    # Add implementation files here:
    # src/hardware_crc32.cpp
    # src/neon_validator.cpp
    # src/serial_port_manager.cpp
    # src/storage_manager.cpp
    # src/dna_processor.cpp
)

# Main executable
add_executable(dna_serial_optimized ${SOURCES})

# Link libraries
target_link_libraries(dna_serial_optimized
    Threads::Threads
    OpenSSL::SSL
    OpenSSL::Crypto
    SQLite::SQLite3
)

# Compiler definitions
target_compile_definitions(dna_serial_optimized PRIVATE
    USE_NEON_SIMD=1
    USE_HW_CRC32=1
    USE_HW_CRYPTO=1
    CACHE_LINE_SIZE=64
)

# Installation
install(TARGETS dna_serial_optimized
    RUNTIME DESTINATION bin
)

install(FILES
    dna_serial_processor_optimized.hpp
    DESTINATION include
)

install(FILES
    IMPLEMENTATION_GUIDE.md
    RPI5_HARDWARE_ANALYSIS.md
    DNA_SERIAL_ANALYSIS.md
    DESTINATION share/doc/dna-serial-processor
)

# Optional: Build tests
option(BUILD_TESTS "Build unit tests" OFF)
if(BUILD_TESTS)
    enable_testing()
    add_subdirectory(tests)
endif()

# Print configuration summary
message(STATUS "")
message(STATUS "DNA Serial Processor - Configuration Summary")
message(STATUS "=============================================")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "ARM64: ${IS_ARM64}")
message(STATUS "OpenSSL: ${OPENSSL_VERSION}")
message(STATUS "SQLite3: ${SQLite3_VERSION}")
message(STATUS "CXX Flags: ${CMAKE_CXX_FLAGS}")
message(STATUS "CXX Flags (Release): ${CMAKE_CXX_FLAGS_RELEASE}")
message(STATUS "Install prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "=============================================")
message(STATUS "")
